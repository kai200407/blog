---
import { Search as SearchIcon } from 'lucide-astro';
---

<div id="search" class="relative">
    <button id="search-trigger" class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-9 w-9">
        <SearchIcon class="h-4 w-4" />
        <span class="sr-only">Search</span>
    </button>
</div>

<dialog id="search-dialog" class="bg-background text-foreground border border-border rounded-lg shadow-lg p-0 backdrop:bg-black/50 w-full max-w-lg open:animate-in open:fade-in-0 open:zoom-in-95 backdrop:animate-in backdrop:fade-in-0">
    <div class="p-4 border-b border-border">
        <div class="relative">
            <SearchIcon class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
            <input 
                type="text" 
                id="search-input" 
                class="flex h-10 w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 pl-10" 
                placeholder="Search..."
            />
        </div>
    </div>
    <div id="search-results" class="max-h-[60vh] overflow-y-auto p-4 space-y-4">
        <!-- Results will be injected here -->
        <p class="text-center text-muted-foreground text-sm py-8">Type to start searching...</p>
    </div>
    <form method="dialog" class="absolute top-2 right-2">
        <button class="text-muted-foreground hover:text-foreground">
            <span class="sr-only">Close</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg>
        </button>
    </form>
</dialog>

<script>
    const trigger = document.getElementById('search-trigger');
    const dialog = document.getElementById('search-dialog') as HTMLDialogElement;
    const input = document.getElementById('search-input') as HTMLInputElement;
    const resultsContainer = document.getElementById('search-results');

    trigger?.addEventListener('click', () => {
        dialog?.showModal();
        input?.focus();
    });

    dialog?.addEventListener('click', (e) => {
        const rect = dialog.getBoundingClientRect();
        const isInDialog = (rect.top <= e.clientY && e.clientY <= rect.top + rect.height
        && rect.left <= e.clientX && e.clientX <= rect.left + rect.width);
        if (!isInDialog) {
            dialog.close();
        }
    });

    // Initialize Pagefind
    let pagefind: any;
    
    const initPagefind = async () => {
        if (pagefind) return;
        try {
            // @ts-ignore
            pagefind = await import('/pagefind/pagefind.js');
            await pagefind.init();
        } catch (e) {
            console.warn('Pagefind not found. It will be available after build.');
        }
    };

    input?.addEventListener('input', async (e) => {
        await initPagefind();
        if (!pagefind) return;

        const query = (e.target as HTMLInputElement).value;
        if (!query) {
            if (resultsContainer) resultsContainer.innerHTML = '<p class="text-center text-muted-foreground text-sm py-8">Type to start searching...</p>';
            return;
        }

        const search = await pagefind.search(query);
        const results = await Promise.all(search.results.map(r => r.data()));

        if (resultsContainer) {
            if (results.length === 0) {
                 resultsContainer.innerHTML = '<p class="text-center text-muted-foreground text-sm py-8">No results found.</p>';
            } else {
                resultsContainer.innerHTML = results.map(r => `
                    <a href="${r.url}" class="block group rounded-lg border p-3 hover:bg-muted transition-colors">
                        <h3 class="font-semibold group-hover:text-primary mb-1">${r.meta.title}</h3>
                        <p class="text-sm text-muted-foreground line-clamp-2">${r.excerpt}</p>
                    </a>
                `).join('');
            }
        }
    });
</script>
