---
title: "ICE 框架 (Interactive Connectivity Establishment)"
description: "1. [ICE 概述](#1-ice-概述)"
pubDate: "2025-12-17"
tags: ["webrtc","audio","video"]
category: "webrtc"
series: "WebRTC 音视频开发"
order: 8
---

> 本文是 WebRTC 系列专栏的第八篇,将深入剖析 ICE 框架的工作原理,包括候选地址发现、连通性检测、状态流程以及 ICE Lite 与 Full ICE 的区别。

---

## 目录

1. [ICE 概述](#1-ice-概述)
2. [ICE 候选地址](#2-ice-候选地址)
3. [候选地址发现](#3-候选地址发现)
4. [连通性检测](#4-连通性检测)
5. [ICE 状态流程](#5-ice-状态流程)
6. [ICE Lite vs Full ICE](#6-ice-lite-vs-full-ice)
7. [ICE 重启](#7-ice-重启)
8. [总结](#8-总结)

---

## 1. ICE 概述

### 1.1 什么是 ICE

ICE (Interactive Connectivity Establishment) 是一个用于在 NAT 环境下建立点对点连接的框架,定义在 RFC 8445 中。ICE 整合了 STUN 和 TURN 协议,提供了一套完整的 NAT 穿透解决方案。

### 1.2 为什么需要 ICE

在互联网环境中,大多数设备位于 NAT 后面,无法直接被外部访问。ICE 解决了以下问题:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        NAT 环境下的通信挑战                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   用户 A                                              用户 B            │
│   192.168.1.100                                      10.0.0.50          │
│        │                                                  │             │
│        │                                                  │             │
│   ┌────┴────┐                                        ┌────┴────┐       │
│   │  NAT A  │                                        │  NAT B  │       │
│   │ 公网 IP │                                        │ 公网 IP │       │
│   │1.2.3.4  │                                        │5.6.7.8  │       │
│   └────┬────┘                                        └────┬────┘       │
│        │                                                  │             │
│        │                  互联网                          │             │
│        └──────────────────────────────────────────────────┘             │
│                                                                         │
│   问题:                                                                 │
│   1. A 不知道 B 的公网地址                                              │
│   2. B 不知道 A 的公网地址                                              │
│   3. NAT 会阻止未经请求的入站连接                                       │
│   4. 不同类型的 NAT 穿透难度不同                                        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.3 ICE 的工作流程概览

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        ICE 工作流程                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   1. 候选地址收集 (Gathering)                                            │
│      ├── 收集本地地址 (host)                                            │
│      ├── 通过 STUN 获取反射地址 (srflx)                                 │
│      └── 通过 TURN 获取中继地址 (relay)                                 │
│                                                                         │
│                              │                                          │
│                              ▼                                          │
│                                                                         │
│   2. 候选地址交换 (Exchange)                                             │
│      └── 通过信令服务器交换候选地址                                      │
│                                                                         │
│                              │                                          │
│                              ▼                                          │
│                                                                         │
│   3. 连通性检测 (Connectivity Checks)                                    │
│      ├── 对所有候选对进行 STUN Binding 请求                             │
│      ├── 检测双向连通性                                                 │
│      └── 发现新的候选地址 (prflx)                                       │
│                                                                         │
│                              │                                          │
│                              ▼                                          │
│                                                                         │
│   4. 候选对选择 (Nomination)                                             │
│      ├── 根据优先级排序                                                 │
│      └── 选择最优候选对                                                 │
│                                                                         │
│                              │                                          │
│                              ▼                                          │
│                                                                         │
│   5. 连接建立 (Connection Established)                                   │
│      └── 使用选定的候选对进行媒体传输                                    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 2. ICE 候选地址

### 2.1 候选地址类型

ICE 定义了四种类型的候选地址:

| 类型 | 英文名 | 说明 | 获取方式 |
|------|--------|------|---------|
| 主机候选 | host | 本地网络接口地址 | 直接获取 |
| 反射候选 | srflx (Server Reflexive) | NAT 映射的公网地址 | 通过 STUN |
| 对端反射候选 | prflx (Peer Reflexive) | 连通性检测中发现的地址 | 动态发现 |
| 中继候选 | relay | TURN 服务器分配的地址 | 通过 TURN |

### 2.2 候选地址结构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        候选地址结构                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   candidate:842163049 1 udp 1677729535 192.168.1.100 54321 typ srflx   │
│   raddr 10.0.0.1 rport 12345 generation 0 ufrag abcd network-cost 999  │
│                                                                         │
│   字段解析:                                                             │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │ foundation     : 842163049      候选基础标识                     │  │
│   │ component      : 1              组件 ID (1=RTP, 2=RTCP)         │  │
│   │ transport      : udp            传输协议                        │  │
│   │ priority       : 1677729535     优先级                          │  │
│   │ address        : 192.168.1.100  候选地址                        │  │
│   │ port           : 54321          端口                            │  │
│   │ type           : srflx          候选类型                        │  │
│   │ raddr          : 10.0.0.1       相关地址 (base address)         │  │
│   │ rport          : 12345          相关端口                        │  │
│   │ generation     : 0              ICE 代数                        │  │
│   │ ufrag          : abcd           用户名片段                      │  │
│   │ network-cost   : 999            网络成本                        │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.3 候选地址优先级

优先级计算公式 (RFC 8445):

```
priority = (2^24) * type_preference +
           (2^8)  * local_preference +
           (2^0)  * (256 - component_id)
```

类型优先级 (type_preference):

| 类型 | 推荐值 | 说明 |
|------|--------|------|
| host | 126 | 最高优先级,直连最快 |
| srflx | 100 | 次优先级,P2P 穿透 |
| prflx | 110 | 动态发现的地址 |
| relay | 0 | 最低优先级,需要中继 |

优先级示例:

```
host 候选:   (2^24)*126 + (2^8)*65535 + (2^0)*255 = 2130706431
srflx 候选:  (2^24)*100 + (2^8)*65535 + (2^0)*255 = 1694498815
relay 候选:  (2^24)*0   + (2^8)*65535 + (2^0)*255 = 16777215
```

### 2.4 组件 (Component)

ICE 为每个媒体流定义了组件:

| 组件 ID | 用途 |
|---------|------|
| 1 | RTP (媒体数据) |
| 2 | RTCP (控制数据) |

在 WebRTC 中,通常使用 RTCP-mux (a=rtcp-mux),将 RTP 和 RTCP 复用到同一端口,因此只需要组件 1。

---

## 3. 候选地址发现

### 3.1 Host 候选发现

Host 候选是本地网络接口的地址,直接从操作系统获取。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Host 候选发现                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   本地设备                                                              │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                                                                 │  │
│   │   网络接口 1 (WiFi)                                             │  │
│   │   └── 192.168.1.100:54321  ──>  host 候选 1                    │  │
│   │                                                                 │  │
│   │   网络接口 2 (以太网)                                           │  │
│   │   └── 10.0.0.50:54322      ──>  host 候选 2                    │  │
│   │                                                                 │  │
│   │   网络接口 3 (VPN)                                              │  │
│   │   └── 172.16.0.10:54323    ──>  host 候选 3                    │  │
│   │                                                                 │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│   注意: 浏览器可能会过滤某些接口以保护隐私                               │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Server Reflexive 候选发现

通过 STUN 服务器发现 NAT 映射的公网地址。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Server Reflexive 候选发现                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   本地设备                        NAT                    STUN 服务器    │
│   192.168.1.100                                         203.0.113.50   │
│        │                           │                         │         │
│        │  1. STUN Binding Request  │                         │         │
│        │  src: 192.168.1.100:54321 │                         │         │
│        │ ─────────────────────────>│                         │         │
│        │                           │                         │         │
│        │                           │  2. NAT 转换            │         │
│        │                           │  src: 1.2.3.4:12345     │         │
│        │                           │ ───────────────────────>│         │
│        │                           │                         │         │
│        │                           │  3. STUN Binding Response         │
│        │                           │  XOR-MAPPED-ADDRESS:    │         │
│        │                           │  1.2.3.4:12345          │         │
│        │                           │<─────────────────────── │         │
│        │                           │                         │         │
│        │  4. 响应转发              │                         │         │
│        │<───────────────────────── │                         │         │
│        │                           │                         │         │
│        │  5. 获得 srflx 候选:                                │         │
│        │     1.2.3.4:12345                                   │         │
│        │     base: 192.168.1.100:54321                       │         │
│        │                                                     │         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.3 Relay 候选发现

通过 TURN 服务器获取中继地址。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Relay 候选发现                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   本地设备                        NAT                    TURN 服务器    │
│   192.168.1.100                                         198.51.100.1   │
│        │                           │                         │         │
│        │  1. TURN Allocate Request │                         │         │
│        │ ─────────────────────────>│                         │         │
│        │                           │ ───────────────────────>│         │
│        │                           │                         │         │
│        │                           │  2. 分配中继地址         │         │
│        │                           │  198.51.100.1:49152     │         │
│        │                           │                         │         │
│        │                           │  3. TURN Allocate Response        │
│        │                           │  RELAYED-ADDRESS:       │         │
│        │                           │  198.51.100.1:49152     │         │
│        │                           │<─────────────────────── │         │
│        │                           │                         │         │
│        │  4. 响应转发              │                         │         │
│        │<───────────────────────── │                         │         │
│        │                           │                         │         │
│        │  5. 获得 relay 候选:                                │         │
│        │     198.51.100.1:49152                              │         │
│        │     base: 192.168.1.100:54321                       │         │
│        │                                                     │         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.4 Peer Reflexive 候选发现

在连通性检测过程中动态发现的候选地址。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Peer Reflexive 候选发现                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   用户 A                          NAT                         用户 B    │
│   192.168.1.100                                              10.0.0.50 │
│        │                           │                              │    │
│        │  1. STUN Binding Request  │                              │    │
│        │  (连通性检测)             │                              │    │
│        │ ─────────────────────────>│                              │    │
│        │                           │                              │    │
│        │                           │  2. NAT 可能使用新端口       │    │
│        │                           │  src: 1.2.3.4:23456          │    │
│        │                           │ ────────────────────────────>│    │
│        │                           │                              │    │
│        │                           │  3. B 发现 A 的新地址        │    │
│        │                           │  1.2.3.4:23456               │    │
│        │                           │  这是 prflx 候选             │    │
│        │                           │                              │    │
│        │                           │  4. STUN Binding Response    │    │
│        │                           │  XOR-MAPPED-ADDRESS:         │    │
│        │                           │  1.2.3.4:23456               │    │
│        │                           │<──────────────────────────── │    │
│        │                           │                              │    │
│        │<───────────────────────── │                              │    │
│        │                                                          │    │
│        │  5. A 也发现了自己的 prflx 候选                          │    │
│        │                                                          │    │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 连通性检测

### 4.1 候选对 (Candidate Pair)

ICE 将本地候选和远端候选组合成候选对进行检测。

```
本地候选:                          远端候选:
┌─────────────────────┐            ┌─────────────────────┐
│ L1: host            │            │ R1: host            │
│ L2: srflx           │            │ R2: srflx           │
│ L3: relay           │            │ R3: relay           │
└─────────────────────┘            └─────────────────────┘

候选对矩阵:
┌─────────────────────────────────────────────────────────┐
│              │    R1 (host)  │  R2 (srflx)  │ R3 (relay)│
├─────────────────────────────────────────────────────────┤
│ L1 (host)    │   L1-R1       │   L1-R2      │  L1-R3    │
│ L2 (srflx)   │   L2-R1       │   L2-R2      │  L2-R3    │
│ L3 (relay)   │   L3-R1       │   L3-R2      │  L3-R3    │
└─────────────────────────────────────────────────────────┘

共 9 个候选对需要检测
```

### 4.2 候选对优先级

候选对优先级计算:

```
pair_priority = 2^32 * MIN(G, D) + 2 * MAX(G, D) + (G > D ? 1 : 0)

其中:
G = controlling agent 的候选优先级
D = controlled agent 的候选优先级
```

### 4.3 连通性检测流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        连通性检测流程                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   用户 A (Controlling)                        用户 B (Controlled)       │
│        │                                              │                 │
│        │  1. STUN Binding Request                     │                 │
│        │  (USE-CANDIDATE 可选)                        │                 │
│        │ ────────────────────────────────────────────>│                 │
│        │                                              │                 │
│        │                                  2. 验证请求 │                 │
│        │                                     检查凭据 │                 │
│        │                                              │                 │
│        │  3. STUN Binding Response                    │                 │
│        │  (XOR-MAPPED-ADDRESS)                        │                 │
│        │<──────────────────────────────────────────── │                 │
│        │                                              │                 │
│        │  4. 触发检测 (Triggered Check)               │                 │
│        │<──────────────────────────────────────────── │                 │
│        │                                              │                 │
│        │  5. STUN Binding Response                    │                 │
│        │ ────────────────────────────────────────────>│                 │
│        │                                              │                 │
│        │  6. 双向连通性确认                           │                 │
│        │     候选对状态: Succeeded                    │                 │
│        │                                              │                 │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.4 候选对状态

| 状态 | 说明 |
|------|------|
| Frozen | 初始状态,等待检测 |
| Waiting | 等待发送检测请求 |
| In-Progress | 检测进行中 |
| Succeeded | 检测成功 |
| Failed | 检测失败 |

状态转换:

```
                    ┌─────────┐
                    │ Frozen  │
                    └────┬────┘
                         │ 解冻
                         ▼
                    ┌─────────┐
                    │ Waiting │
                    └────┬────┘
                         │ 发送请求
                         ▼
                    ┌───────────────┐
                    │  In-Progress  │
                    └───────┬───────┘
                            │
              ┌─────────────┴─────────────┐
              │                           │
              ▼                           ▼
        ┌───────────┐              ┌──────────┐
        │ Succeeded │              │  Failed  │
        └───────────┘              └──────────┘
```

### 4.5 STUN 凭据

ICE 使用短期凭据进行身份验证:

```
STUN 请求中包含:
- USERNAME: 远端 ufrag:本地 ufrag (如 "abcd:efgh")
- MESSAGE-INTEGRITY: 使用远端 ice-pwd 计算的 HMAC

STUN 响应中包含:
- MESSAGE-INTEGRITY: 使用本地 ice-pwd 计算的 HMAC
```

---

## 5. ICE 状态流程

### 5.1 ICE 收集状态 (Gathering State)

```javascript
pc.onicegatheringstatechange = () => {
    console.log('ICE 收集状态:', pc.iceGatheringState);
};
```

| 状态 | 说明 |
|------|------|
| new | 初始状态,未开始收集 |
| gathering | 正在收集候选地址 |
| complete | 收集完成 |

状态转换:

```
        ┌─────────┐
        │   new   │
        └────┬────┘
             │ setLocalDescription()
             ▼
        ┌───────────┐
        │ gathering │
        └─────┬─────┘
              │ 所有候选收集完成
              ▼
        ┌───────────┐
        │ complete  │
        └───────────┘
```

### 5.2 ICE 连接状态 (Connection State)

```javascript
pc.oniceconnectionstatechange = () => {
    console.log('ICE 连接状态:', pc.iceConnectionState);
};
```

| 状态 | 说明 |
|------|------|
| new | 初始状态 |
| checking | 正在进行连通性检测 |
| connected | 至少有一个候选对成功 |
| completed | 所有检测完成,已选择最优候选对 |
| failed | 所有候选对检测失败 |
| disconnected | 连接暂时中断 |
| closed | ICE 代理已关闭 |

状态转换图:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        ICE 连接状态转换                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│                           ┌─────────┐                                   │
│                           │   new   │                                   │
│                           └────┬────┘                                   │
│                                │ 开始检测                               │
│                                ▼                                        │
│                           ┌──────────┐                                  │
│                      ┌───>│ checking │<───┐                             │
│                      │    └────┬─────┘    │                             │
│                      │         │          │                             │
│              ICE 重启 │         │ 检测成功 │ 连接恢复                    │
│                      │         ▼          │                             │
│                      │    ┌───────────┐   │                             │
│                      │    │ connected │───┤                             │
│                      │    └─────┬─────┘   │                             │
│                      │          │         │                             │
│                      │          │ 所有检测完成                          │
│                      │          ▼         │                             │
│                      │    ┌───────────┐   │                             │
│                      ├────│ completed │───┤                             │
│                      │    └─────┬─────┘   │                             │
│                      │          │         │                             │
│                      │          │ 连接中断│                             │
│                      │          ▼         │                             │
│                      │    ┌──────────────┐│                             │
│                      └────│ disconnected │┘                             │
│                           └──────┬───────┘                              │
│                                  │                                      │
│                                  │ 超时/失败                            │
│                                  ▼                                      │
│                           ┌──────────┐                                  │
│                           │  failed  │                                  │
│                           └──────────┘                                  │
│                                                                         │
│   任何状态 ──── close() ────> closed                                    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.3 状态处理示例

```javascript
const pc = new RTCPeerConnection(config);

pc.oniceconnectionstatechange = () => {
    const state = pc.iceConnectionState;
    console.log('ICE 状态:', state);
    
    switch (state) {
        case 'checking':
            showStatus('正在建立连接...');
            break;
            
        case 'connected':
            showStatus('连接已建立');
            break;
            
        case 'completed':
            showStatus('连接已优化');
            break;
            
        case 'disconnected':
            showStatus('连接中断,尝试恢复...');
            // 可以等待自动恢复
            break;
            
        case 'failed':
            showStatus('连接失败');
            // 可以尝试 ICE 重启
            handleConnectionFailure();
            break;
            
        case 'closed':
            showStatus('连接已关闭');
            break;
    }
};

async function handleConnectionFailure() {
    // 尝试 ICE 重启
    const offer = await pc.createOffer({ iceRestart: true });
    await pc.setLocalDescription(offer);
    sendOfferToRemote(offer);
}
```

---

## 6. ICE Lite vs Full ICE

### 6.1 Full ICE

Full ICE 是完整的 ICE 实现,包含所有功能:

- 收集所有类型的候选地址
- 进行完整的连通性检测
- 支持 Controlling 和 Controlled 角色
- 支持候选对优先级排序和选择

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Full ICE 特点                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   功能:                                                                 │
│   - 收集 host, srflx, relay 候选                                       │
│   - 完整的连通性检测                                                    │
│   - 支持 Trickle ICE                                                   │
│   - 支持 ICE 重启                                                      │
│   - 动态角色协商                                                        │
│                                                                         │
│   适用场景:                                                             │
│   - 浏览器端                                                            │
│   - 移动客户端                                                          │
│   - 需要 NAT 穿透的场景                                                 │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 6.2 ICE Lite

ICE Lite 是简化的 ICE 实现,适用于具有公网地址的服务器:

- 只收集 host 候选 (公网地址)
- 不主动发起连通性检测
- 只响应对端的检测请求
- 始终作为 Controlled 角色

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        ICE Lite 特点                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   功能:                                                                 │
│   - 只收集 host 候选 (公网 IP)                                         │
│   - 不主动发起连通性检测                                                │
│   - 只响应检测请求                                                      │
│   - 始终为 Controlled 角色                                             │
│                                                                         │
│   适用场景:                                                             │
│   - 媒体服务器 (SFU/MCU)                                               │
│   - 具有公网 IP 的服务端                                               │
│   - 不需要 NAT 穿透的场景                                              │
│                                                                         │
│   SDP 标识:                                                             │
│   a=ice-lite                                                           │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 6.3 Full ICE vs ICE Lite 对比

| 特性 | Full ICE | ICE Lite |
|------|----------|----------|
| 候选收集 | host, srflx, relay | 仅 host |
| 连通性检测 | 主动发起 | 仅响应 |
| 角色 | Controlling 或 Controlled | 仅 Controlled |
| 适用场景 | 客户端 | 服务器 |
| 实现复杂度 | 高 | 低 |
| NAT 穿透 | 支持 | 不支持 |

### 6.4 角色协商

ICE 定义了两种角色:

| 角色 | 说明 |
|------|------|
| Controlling | 控制方,负责选择最终的候选对 |
| Controlled | 被控方,接受控制方的选择 |

角色确定规则:

1. ICE Lite 始终为 Controlled
2. 两个 Full ICE 之间,通过 tie-breaker 确定
3. Offer 方通常为 Controlling (可配置)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        角色协商                                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   场景 1: Full ICE vs Full ICE                                          │
│   ┌─────────────────┐              ┌─────────────────┐                 │
│   │   Full ICE A    │              │   Full ICE B    │                 │
│   │  (Controlling)  │<────────────>│  (Controlled)   │                 │
│   └─────────────────┘              └─────────────────┘                 │
│   通过 tie-breaker 确定角色                                             │
│                                                                         │
│   场景 2: Full ICE vs ICE Lite                                          │
│   ┌─────────────────┐              ┌─────────────────┐                 │
│   │   Full ICE      │              │   ICE Lite      │                 │
│   │  (Controlling)  │<────────────>│  (Controlled)   │                 │
│   └─────────────────┘              └─────────────────┘                 │
│   ICE Lite 始终为 Controlled                                            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 7. ICE 重启

### 7.1 什么时候需要 ICE 重启

- 网络切换 (WiFi 切换到 4G)
- IP 地址变化
- 连接失败需要重试
- 长时间 disconnected 状态

### 7.2 ICE 重启流程

```javascript
// 触发 ICE 重启
async function restartIce() {
    // 创建带有 iceRestart 选项的 Offer
    const offer = await pc.createOffer({ iceRestart: true });
    await pc.setLocalDescription(offer);
    
    // 发送新的 Offer 到远端
    sendOfferToRemote(offer);
}

// 监听连接状态,在失败时重启
pc.oniceconnectionstatechange = () => {
    if (pc.iceConnectionState === 'failed') {
        restartIce();
    }
};
```

### 7.3 ICE 重启的特点

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        ICE 重启                                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   重启时会发生:                                                          │
│   1. 生成新的 ice-ufrag 和 ice-pwd                                      │
│   2. 重新收集所有候选地址                                                │
│   3. 重新进行连通性检测                                                  │
│   4. 媒体传输可能短暂中断                                                │
│                                                                         │
│   SDP 变化:                                                             │
│   旧 SDP:                                                               │
│   a=ice-ufrag:abcd                                                     │
│   a=ice-pwd:efghijklmnopqrstuvwxyz                                     │
│                                                                         │
│   新 SDP (ICE 重启后):                                                  │
│   a=ice-ufrag:wxyz  <-- 新的 ufrag                                     │
│   a=ice-pwd:1234567890abcdefghijkl  <-- 新的 pwd                       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 7.4 使用 restartIce() 方法

现代浏览器支持 restartIce() 方法:

```javascript
// 简化的 ICE 重启
pc.restartIce();

// 然后需要重新协商
pc.onnegotiationneeded = async () => {
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    sendOfferToRemote(offer);
};
```

---

## 8. 总结

### 8.1 ICE 核心要点

| 要点 | 说明 |
|------|------|
| 候选类型 | host, srflx, prflx, relay |
| 候选优先级 | host > prflx > srflx > relay |
| 连通性检测 | 使用 STUN Binding 请求 |
| 状态机 | new -> checking -> connected/completed -> failed/closed |
| ICE Lite | 简化实现,适用于服务器 |
| ICE 重启 | 网络变化时重新建立连接 |

### 8.2 ICE 调试技巧

1. 使用 chrome://webrtc-internals 查看 ICE 状态
2. 检查候选地址是否正确收集
3. 验证 STUN/TURN 服务器是否可用
4. 观察连通性检测结果
5. 注意 ICE 状态转换

### 8.3 下一篇预告

在下一篇文章中,我们将深入探讨 STUN 协议,包括:
- STUN 协议格式
- Binding Request/Response
- STUN 服务器搭建

---

## 参考资料

1. [RFC 8445 - Interactive Connectivity Establishment (ICE)](https://datatracker.ietf.org/doc/html/rfc8445)
2. [RFC 8838 - Trickle ICE](https://datatracker.ietf.org/doc/html/rfc8838)
3. [RFC 8863 - ICE Lite](https://datatracker.ietf.org/doc/html/rfc8863)
4. [WebRTC ICE - MDN](https://developer.mozilla.org/en-US/docs/Web/API/WebRTC_API/Connectivity)

---

> 作者: WebRTC 技术专栏  
> 系列: 信令与会话管理 (3/6)  
> 上一篇: [深度理解 SDP](./07-sdp-deep-dive.md)  
> 下一篇: [STUN: 外网地址发现](./09-stun-protocol.md)
