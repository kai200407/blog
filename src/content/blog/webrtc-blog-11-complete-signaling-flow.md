---
title: "完整的 WebRTC 信令流程图 (从建立到关闭)"
description: "1. [流程概览](#1-流程概览)"
pubDate: "2025-12-17"
tags: ["webrtc","audio","video"]
category: "webrtc"
series: "WebRTC 音视频开发"
order: 11
---

> 本文是 WebRTC 系列专栏的第十一篇,也是第二部分"信令与会话管理"的收官之作。我们将完整梳理 WebRTC 从连接建立到关闭的全过程,帮助你建立对 WebRTC 建链流程从 0 到 1 的完整理解。

---

## 目录

1. [流程概览](#1-流程概览)
2. [Offer/Answer 交换](#2-offeranswer-交换)
3. [ICE Candidate Trickle](#3-ice-candidate-trickle)
4. [DTLS 握手](#4-dtls-握手)
5. [SRTP 建立](#5-srtp-建立)
6. [媒体传输](#6-媒体传输)
7. [连接关闭](#7-连接关闭)
8. [完整时序图](#8-完整时序图)
9. [总结](#9-总结)

---

## 1. 流程概览

### 1.1 WebRTC 连接建立的五个阶段

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    WebRTC 连接建立五阶段                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   阶段 1: 信令交换                                                       │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │  Offer/Answer 交换 + ICE Candidate Trickle                      │  │
│   │  目的: 交换媒体能力和网络信息                                    │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                    │                                    │
│                                    ▼                                    │
│   阶段 2: ICE 连通性检测                                                │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │  STUN Binding 请求/响应                                         │  │
│   │  目的: 找到可用的网络路径                                        │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                    │                                    │
│                                    ▼                                    │
│   阶段 3: DTLS 握手                                                     │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │  DTLS ClientHello/ServerHello/Finished                          │  │
│   │  目的: 建立安全通道,交换密钥                                     │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                    │                                    │
│                                    ▼                                    │
│   阶段 4: SRTP 密钥导出                                                 │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │  从 DTLS 主密钥导出 SRTP 密钥                                   │  │
│   │  目的: 准备媒体加密                                             │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                    │                                    │
│                                    ▼                                    │
│   阶段 5: 媒体传输                                                      │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │  SRTP/SRTCP 数据包传输                                          │  │
│   │  目的: 传输加密的音视频数据                                      │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.2 协议栈层次

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        WebRTC 协议栈                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                         应用层                                   │  │
│   │              音视频数据 / DataChannel 数据                       │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                    │                                    │
│                    ┌───────────────┴───────────────┐                   │
│                    ▼                               ▼                   │
│   ┌─────────────────────────────┐  ┌─────────────────────────────┐    │
│   │           SRTP              │  │           SCTP              │    │
│   │      (加密媒体传输)          │  │      (数据通道传输)          │    │
│   └──────────────┬──────────────┘  └──────────────┬──────────────┘    │
│                  │                                │                    │
│                  └────────────────┬───────────────┘                    │
│                                   ▼                                    │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                          DTLS                                    │  │
│   │                    (密钥交换与加密)                               │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                   │                                    │
│                                   ▼                                    │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                           ICE                                    │  │
│   │                      (NAT 穿透)                                  │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                   │                                    │
│                                   ▼                                    │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                        UDP / TCP                                 │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Offer/Answer 交换

### 2.1 Offer 创建过程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Offer 创建过程                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   发起方 (Caller)                                                       │
│        │                                                                │
│        │  1. 获取本地媒体流                                             │
│        │     navigator.mediaDevices.getUserMedia()                      │
│        │                                                                │
│        ▼                                                                │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │  2. 创建 RTCPeerConnection                                      │  │
│   │     const pc = new RTCPeerConnection(config);                   │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│        │                                                                │
│        ▼                                                                │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │  3. 添加媒体轨道                                                 │  │
│   │     stream.getTracks().forEach(track => pc.addTrack(track));    │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│        │                                                                │
│        ▼                                                                │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │  4. 创建 Offer                                                   │  │
│   │     const offer = await pc.createOffer();                       │  │
│   │                                                                 │  │
│   │     Offer 包含:                                                 │  │
│   │     - 支持的编解码器列表                                        │  │
│   │     - 媒体方向 (sendrecv/sendonly/recvonly)                     │  │
│   │     - ICE 凭据 (ice-ufrag, ice-pwd)                            │  │
│   │     - DTLS 指纹 (fingerprint)                                  │  │
│   │     - DTLS 角色 (setup: actpass)                               │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│        │                                                                │
│        ▼                                                                │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │  5. 设置本地描述                                                 │  │
│   │     await pc.setLocalDescription(offer);                        │  │
│   │                                                                 │  │
│   │     触发:                                                       │  │
│   │     - ICE 候选收集开始                                          │  │
│   │     - iceGatheringState: new -> gathering                      │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│        │                                                                │
│        ▼                                                                │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │  6. 通过信令服务器发送 Offer                                     │  │
│   │     signaling.send({ type: 'offer', sdp: offer.sdp });          │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 Answer 创建过程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Answer 创建过程                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   接收方 (Callee)                                                       │
│        │                                                                │
│        │  1. 收到 Offer                                                 │
│        │     signaling.on('offer', handleOffer);                        │
│        │                                                                │
│        ▼                                                                │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │  2. 创建 RTCPeerConnection                                      │  │
│   │     const pc = new RTCPeerConnection(config);                   │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│        │                                                                │
│        ▼                                                                │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │  3. 设置远端描述                                                 │  │
│   │     await pc.setRemoteDescription(offer);                       │  │
│   │                                                                 │  │
│   │     解析 Offer:                                                 │  │
│   │     - 提取对方支持的编解码器                                    │  │
│   │     - 提取 ICE 凭据                                            │  │
│   │     - 提取 DTLS 指纹                                           │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│        │                                                                │
│        ▼                                                                │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │  4. 获取本地媒体流并添加轨道                                     │  │
│   │     const stream = await navigator.mediaDevices.getUserMedia(); │  │
│   │     stream.getTracks().forEach(track => pc.addTrack(track));    │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│        │                                                                │
│        ▼                                                                │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │  5. 创建 Answer                                                  │  │
│   │     const answer = await pc.createAnswer();                     │  │
│   │                                                                 │  │
│   │     Answer 包含:                                                │  │
│   │     - 协商后的编解码器 (Offer 和本地能力的交集)                  │  │
│   │     - 媒体方向                                                  │  │
│   │     - ICE 凭据                                                 │  │
│   │     - DTLS 指纹                                                │  │
│   │     - DTLS 角色 (setup: active 或 passive)                     │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│        │                                                                │
│        ▼                                                                │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │  6. 设置本地描述                                                 │  │
│   │     await pc.setLocalDescription(answer);                       │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│        │                                                                │
│        ▼                                                                │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │  7. 通过信令服务器发送 Answer                                    │  │
│   │     signaling.send({ type: 'answer', sdp: answer.sdp });        │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.3 信令状态转换

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        信令状态转换                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   发起方 (Caller)                          接收方 (Callee)              │
│                                                                         │
│   signalingState: stable                   signalingState: stable       │
│        │                                        │                       │
│        │ setLocalDescription(offer)             │                       │
│        ▼                                        │                       │
│   signalingState: have-local-offer              │                       │
│        │                                        │                       │
│        │ ──────── Offer ────────────────────────>                       │
│        │                                        │                       │
│        │                                        │ setRemoteDescription  │
│        │                                        ▼                       │
│        │                          signalingState: have-remote-offer     │
│        │                                        │                       │
│        │                                        │ setLocalDescription   │
│        │                                        ▼                       │
│        │                          signalingState: stable                │
│        │                                        │                       │
│        │ <──────── Answer ──────────────────────│                       │
│        │                                        │                       │
│        │ setRemoteDescription(answer)           │                       │
│        ▼                                        │                       │
│   signalingState: stable                        │                       │
│        │                                        │                       │
│        │                                        │                       │
│   协商完成,双方都处于 stable 状态                                       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 3. ICE Candidate Trickle

### 3.1 Trickle ICE 概念

Trickle ICE 允许在收集到候选地址后立即发送,而不是等待所有候选收集完成。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Trickle ICE vs 传统 ICE                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   传统 ICE (非 Trickle):                                                │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │  1. 收集所有候选 (可能需要几秒)                                  │  │
│   │  2. 将所有候选包含在 SDP 中                                     │  │
│   │  3. 发送 SDP                                                    │  │
│   │  4. 等待对方 SDP                                                │  │
│   │  5. 开始连通性检测                                              │  │
│   │                                                                 │  │
│   │  问题: 连接建立时间长                                           │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│   Trickle ICE:                                                          │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │  1. 立即发送 SDP (不含候选或只含部分候选)                        │  │
│   │  2. 收集到候选后立即发送                                        │  │
│   │  3. 边收集边检测                                                │  │
│   │                                                                 │  │
│   │  优势: 连接建立更快                                             │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 ICE Candidate 交换流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        ICE Candidate 交换流程                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   用户 A                      信令服务器                      用户 B    │
│      │                            │                              │      │
│      │  setLocalDescription()     │                              │      │
│      │  开始收集候选              │                              │      │
│      │                            │                              │      │
│      │  onicecandidate: host      │                              │      │
│      │ ──────────────────────────>│                              │      │
│      │                            │ ────────────────────────────>│      │
│      │                            │                              │      │
│      │  onicecandidate: srflx     │                              │      │
│      │ ──────────────────────────>│                              │      │
│      │                            │ ────────────────────────────>│      │
│      │                            │                              │      │
│      │  onicecandidate: relay     │                              │      │
│      │ ──────────────────────────>│                              │      │
│      │                            │ ────────────────────────────>│      │
│      │                            │                              │      │
│      │  onicecandidate: null      │                              │      │
│      │  (收集完成)                │                              │      │
│      │                            │                              │      │
│      │                            │  B 也在收集并发送候选        │      │
│      │                            │<──────────────────────────── │      │
│      │<────────────────────────── │                              │      │
│      │                            │                              │      │
│      │  addIceCandidate()         │                              │      │
│      │                            │                              │      │
│      │  ═══════════ 双方开始连通性检测 ═══════════                │      │
│      │                            │                              │      │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.3 代码实现

```javascript
// 发送方
pc.onicecandidate = (event) => {
    if (event.candidate) {
        // 发送候选到远端
        signaling.send({
            type: 'candidate',
            candidate: event.candidate.candidate,
            sdpMid: event.candidate.sdpMid,
            sdpMLineIndex: event.candidate.sdpMLineIndex
        });
    } else {
        // 候选收集完成
        console.log('ICE candidate gathering complete');
    }
};

// 接收方
signaling.on('candidate', async (data) => {
    if (data.candidate) {
        await pc.addIceCandidate(new RTCIceCandidate({
            candidate: data.candidate,
            sdpMid: data.sdpMid,
            sdpMLineIndex: data.sdpMLineIndex
        }));
    }
});
```

### 3.4 ICE 连接状态变化

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        ICE 连接状态变化                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   iceConnectionState 变化:                                              │
│                                                                         │
│   new ──> checking ──> connected ──> completed                          │
│             │              │              │                             │
│             │              │              └──> disconnected ──> failed  │
│             │              │                        │                   │
│             │              └────────────────────────┘                   │
│             │                                                           │
│             └──> failed                                                 │
│                                                                         │
│   iceGatheringState 变化:                                               │
│                                                                         │
│   new ──> gathering ──> complete                                        │
│                                                                         │
│   connectionState 变化:                                                 │
│                                                                         │
│   new ──> connecting ──> connected                                      │
│                │              │                                         │
│                │              └──> disconnected ──> failed              │
│                │                                                        │
│                └──> failed                                              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. DTLS 握手

### 4.1 DTLS 概述

DTLS (Datagram Transport Layer Security) 是 TLS 在 UDP 上的实现,用于在 WebRTC 中建立安全通道。

### 4.2 DTLS 角色确定

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        DTLS 角色确定                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   SDP 中的 setup 属性:                                                  │
│                                                                         │
│   Offer:  a=setup:actpass   (可以作为客户端或服务端)                    │
│   Answer: a=setup:active    (作为 DTLS 客户端,发起握手)                 │
│           或                                                            │
│           a=setup:passive   (作为 DTLS 服务端,等待握手)                 │
│                                                                         │
│   通常情况:                                                             │
│   - Offer 方: setup:actpass                                            │
│   - Answer 方: setup:active (主动发起 DTLS 握手)                       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.3 DTLS 握手流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        DTLS 握手流程                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   DTLS Client                                          DTLS Server      │
│   (setup:active)                                      (setup:passive)   │
│        │                                                     │          │
│        │  1. ClientHello                                     │          │
│        │  - 支持的密码套件                                   │          │
│        │  - 随机数                                           │          │
│        │ ──────────────────────────────────────────────────> │          │
│        │                                                     │          │
│        │  2. HelloVerifyRequest (防止 DoS)                   │          │
│        │  - Cookie                                           │          │
│        │ <────────────────────────────────────────────────── │          │
│        │                                                     │          │
│        │  3. ClientHello (带 Cookie)                         │          │
│        │ ──────────────────────────────────────────────────> │          │
│        │                                                     │          │
│        │  4. ServerHello                                     │          │
│        │  - 选择的密码套件                                   │          │
│        │  - 随机数                                           │          │
│        │                                                     │          │
│        │  5. Certificate                                     │          │
│        │  - 服务端证书                                       │          │
│        │                                                     │          │
│        │  6. ServerKeyExchange                               │          │
│        │  - ECDHE 参数                                       │          │
│        │                                                     │          │
│        │  7. CertificateRequest                              │          │
│        │  - 请求客户端证书                                   │          │
│        │                                                     │          │
│        │  8. ServerHelloDone                                 │          │
│        │ <────────────────────────────────────────────────── │          │
│        │                                                     │          │
│        │  9. Certificate                                     │          │
│        │  - 客户端证书                                       │          │
│        │                                                     │          │
│        │  10. ClientKeyExchange                              │          │
│        │  - ECDHE 公钥                                       │          │
│        │                                                     │          │
│        │  11. CertificateVerify                              │          │
│        │  - 证书签名                                         │          │
│        │                                                     │          │
│        │  12. ChangeCipherSpec                               │          │
│        │  - 切换到加密模式                                   │          │
│        │                                                     │          │
│        │  13. Finished                                       │          │
│        │  - 握手完成验证                                     │          │
│        │ ──────────────────────────────────────────────────> │          │
│        │                                                     │          │
│        │  14. ChangeCipherSpec                               │          │
│        │                                                     │          │
│        │  15. Finished                                       │          │
│        │ <────────────────────────────────────────────────── │          │
│        │                                                     │          │
│        │  ═══════════ DTLS 握手完成 ═══════════              │          │
│        │                                                     │          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.4 证书验证

WebRTC 使用自签名证书,通过 SDP 中的 fingerprint 验证:

```
SDP 中:
a=fingerprint:sha-256 AA:BB:CC:DD:EE:FF:00:11:22:33:44:55:66:77:88:99:...

验证过程:
1. 收到对方的 DTLS 证书
2. 计算证书的 SHA-256 哈希
3. 与 SDP 中的 fingerprint 比较
4. 匹配则验证通过
```

---

## 5. SRTP 建立

### 5.1 SRTP 密钥导出

DTLS 握手完成后,从主密钥导出 SRTP 密钥。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        SRTP 密钥导出                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   DTLS 主密钥 (Master Secret)                                           │
│        │                                                                │
│        ▼                                                                │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                    密钥导出函数 (KDF)                            │  │
│   │                                                                 │  │
│   │  PRF(master_secret, "EXTRACTOR-dtls_srtp",                      │  │
│   │      client_random + server_random)                             │  │
│   │                                                                 │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│        │                                                                │
│        ├──> Client Write Master Key (16 bytes)                         │
│        ├──> Server Write Master Key (16 bytes)                         │
│        ├──> Client Write Master Salt (14 bytes)                        │
│        └──> Server Write Master Salt (14 bytes)                        │
│                                                                         │
│   密钥用途:                                                             │
│   - Client Write Key: 客户端发送数据的加密密钥                          │
│   - Server Write Key: 服务端发送数据的加密密钥                          │
│   - Salt: 用于密钥派生                                                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.2 SRTP 加密

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        SRTP 加密流程                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   RTP 包 (明文)                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │  RTP Header (12 bytes)  │  RTP Payload (音视频数据)             │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│        │                                                                │
│        ▼                                                                │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                      SRTP 加密                                   │  │
│   │                                                                 │  │
│   │  1. 生成密钥流 (AES-CM)                                         │  │
│   │     keystream = AES(session_key, IV)                            │  │
│   │                                                                 │  │
│   │  2. 加密负载                                                    │  │
│   │     encrypted_payload = payload XOR keystream                   │  │
│   │                                                                 │  │
│   │  3. 计算认证标签 (HMAC-SHA1)                                    │  │
│   │     auth_tag = HMAC(auth_key, header + encrypted_payload)       │  │
│   │                                                                 │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│        │                                                                │
│        ▼                                                                │
│   SRTP 包 (密文)                                                        │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │  RTP Header  │  Encrypted Payload  │  Auth Tag (10 bytes)      │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│   注意: RTP Header 不加密,但包含在认证范围内                            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 媒体传输

### 6.1 媒体数据流

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        媒体数据流                                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   发送端                                                  接收端        │
│                                                                         │
│   ┌─────────────┐                                                       │
│   │ 摄像头/麦克风│                                                       │
│   └──────┬──────┘                                                       │
│          │ 原始音视频                                                   │
│          ▼                                                              │
│   ┌─────────────┐                                                       │
│   │   编码器    │                                                       │
│   │ (VP8/Opus)  │                                                       │
│   └──────┬──────┘                                                       │
│          │ 编码后数据                                                   │
│          ▼                                                              │
│   ┌─────────────┐                                                       │
│   │  RTP 打包   │                                                       │
│   └──────┬──────┘                                                       │
│          │ RTP 包                                                       │
│          ▼                                                              │
│   ┌─────────────┐                                                       │
│   │  SRTP 加密  │                                                       │
│   └──────┬──────┘                                                       │
│          │ SRTP 包                                                      │
│          ▼                                                              │
│   ┌─────────────┐                                    ┌─────────────┐   │
│   │    网络     │ ═══════════════════════════════════>│    网络     │   │
│   └─────────────┘                                    └──────┬──────┘   │
│                                                             │          │
│                                                             ▼          │
│                                                      ┌─────────────┐   │
│                                                      │  SRTP 解密  │   │
│                                                      └──────┬──────┘   │
│                                                             │          │
│                                                             ▼          │
│                                                      ┌─────────────┐   │
│                                                      │  RTP 解包   │   │
│                                                      └──────┬──────┘   │
│                                                             │          │
│                                                             ▼          │
│                                                      ┌─────────────┐   │
│                                                      │ 抖动缓冲    │   │
│                                                      └──────┬──────┘   │
│                                                             │          │
│                                                             ▼          │
│                                                      ┌─────────────┐   │
│                                                      │   解码器    │   │
│                                                      └──────┬──────┘   │
│                                                             │          │
│                                                             ▼          │
│                                                      ┌─────────────┐   │
│                                                      │ 扬声器/显示 │   │
│                                                      └─────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 6.2 RTCP 反馈

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        RTCP 反馈机制                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   发送端                                                  接收端        │
│      │                                                       │          │
│      │  SRTP (媒体数据)                                      │          │
│      │ ═════════════════════════════════════════════════════>│          │
│      │                                                       │          │
│      │                                    SRTCP (Receiver Report)       │
│      │                                    - 丢包率                      │
│      │                                    - 抖动                        │
│      │                                    - 延迟                        │
│      │<═════════════════════════════════════════════════════ │          │
│      │                                                       │          │
│      │  根据反馈调整:                                        │          │
│      │  - 调整码率                                           │          │
│      │  - 重传丢失的包 (NACK)                                │          │
│      │  - 发送关键帧 (PLI/FIR)                               │          │
│      │                                                       │          │
│      │  SRTCP (Sender Report)                                │          │
│      │  - 发送统计                                           │          │
│      │  - 时间戳同步                                         │          │
│      │ ═════════════════════════════════════════════════════>│          │
│      │                                                       │          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 7. 连接关闭

### 7.1 正常关闭流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        正常关闭流程                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   用户 A                      信令服务器                      用户 B    │
│      │                            │                              │      │
│      │  1. 用户点击挂断          │                              │      │
│      │                            │                              │      │
│      │  2. 停止本地媒体轨道       │                              │      │
│      │     localStream.getTracks().forEach(t => t.stop());      │      │
│      │                            │                              │      │
│      │  3. 发送挂断信令           │                              │      │
│      │ ──────────────────────────>│                              │      │
│      │                            │ ────────────────────────────>│      │
│      │                            │                              │      │
│      │  4. 关闭 PeerConnection    │                              │      │
│      │     pc.close();            │                              │      │
│      │                            │                              │      │
│      │                            │              5. 收到挂断信令 │      │
│      │                            │                              │      │
│      │                            │              6. 停止本地媒体 │      │
│      │                            │                              │      │
│      │                            │              7. 关闭 PC      │      │
│      │                            │                 pc.close();  │      │
│      │                            │                              │      │
│      │  connectionState: closed   │      connectionState: closed │      │
│      │                            │                              │      │
└─────────────────────────────────────────────────────────────────────────┘
```

### 7.2 异常关闭处理

```javascript
// 监听连接状态变化
pc.onconnectionstatechange = () => {
    switch (pc.connectionState) {
        case 'disconnected':
            // 连接暂时中断
            console.log('Connection disconnected, waiting for recovery...');
            startReconnectTimer();
            break;
            
        case 'failed':
            // 连接失败
            console.log('Connection failed');
            handleConnectionFailure();
            break;
            
        case 'closed':
            // 连接已关闭
            console.log('Connection closed');
            cleanup();
            break;
    }
};

// 监听 ICE 连接状态
pc.oniceconnectionstatechange = () => {
    if (pc.iceConnectionState === 'failed') {
        // 尝试 ICE 重启
        pc.restartIce();
    }
};

// 清理资源
function cleanup() {
    // 停止所有轨道
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
    }
    
    // 关闭 PeerConnection
    if (pc) {
        pc.close();
        pc = null;
    }
    
    // 清理 UI
    localVideo.srcObject = null;
    remoteVideo.srcObject = null;
}
```

### 7.3 资源释放检查清单

```
关闭连接时需要释放的资源:

[ ] 停止本地媒体轨道 (track.stop())
[ ] 关闭 PeerConnection (pc.close())
[ ] 清理视频元素 (video.srcObject = null)
[ ] 关闭数据通道 (dataChannel.close())
[ ] 断开信令连接 (如果需要)
[ ] 清理事件监听器
[ ] 重置 UI 状态
```

---

## 8. 完整时序图

### 8.1 完整的连接建立时序

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    完整的 WebRTC 连接建立时序                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   用户 A              信令服务器              STUN/TURN              用户 B
│      │                    │                      │                    │
│      │                    │                      │                    │
│  ════════════════════ 阶段 1: 信令交换 ════════════════════            │
│      │                    │                      │                    │
│      │ getUserMedia()     │                      │                    │
│      │ new RTCPeerConnection()                   │                    │
│      │ addTrack()         │                      │                    │
│      │ createOffer()      │                      │                    │
│      │ setLocalDescription()                     │                    │
│      │                    │                      │                    │
│      │ ── Offer ─────────>│                      │                    │
│      │                    │ ── Offer ───────────────────────────────> │
│      │                    │                      │                    │
│      │                    │                      │   getUserMedia()   │
│      │                    │                      │   new RTCPeerConnection()
│      │                    │                      │   setRemoteDescription()
│      │                    │                      │   addTrack()       │
│      │                    │                      │   createAnswer()   │
│      │                    │                      │   setLocalDescription()
│      │                    │                      │                    │
│      │                    │ <── Answer ─────────────────────────────  │
│      │ <── Answer ─────── │                      │                    │
│      │                    │                      │                    │
│      │ setRemoteDescription()                    │                    │
│      │                    │                      │                    │
│  ════════════════════ 阶段 2: ICE 候选交换 ════════════════════        │
│      │                    │                      │                    │
│      │ ── Candidate ─────>│                      │                    │
│      │                    │ ── Candidate ───────────────────────────> │
│      │                    │                      │                    │
│      │                    │ <── Candidate ─────────────────────────── │
│      │ <── Candidate ──── │                      │                    │
│      │                    │                      │                    │
│      │ addIceCandidate()  │                      │   addIceCandidate()│
│      │                    │                      │                    │
│  ════════════════════ 阶段 3: ICE 连通性检测 ════════════════════      │
│      │                    │                      │                    │
│      │ ─────────────── STUN Binding Request ────────────────────────> │
│      │ <────────────── STUN Binding Response ─────────────────────── │
│      │                    │                      │                    │
│      │ <────────────── STUN Binding Request ──────────────────────── │
│      │ ─────────────── STUN Binding Response ───────────────────────> │
│      │                    │                      │                    │
│      │ iceConnectionState: checking -> connected │                    │
│      │                    │                      │                    │
│  ════════════════════ 阶段 4: DTLS 握手 ════════════════════           │
│      │                    │                      │                    │
│      │ ─────────────── DTLS ClientHello ────────────────────────────> │
│      │ <────────────── DTLS HelloVerifyRequest ─────────────────────  │
│      │ ─────────────── DTLS ClientHello (with cookie) ──────────────> │
│      │ <────────────── DTLS ServerHello, Certificate, etc. ─────────  │
│      │ ─────────────── DTLS Certificate, KeyExchange, Finished ─────> │
│      │ <────────────── DTLS Finished ───────────────────────────────  │
│      │                    │                      │                    │
│  ════════════════════ 阶段 5: SRTP 建立 ════════════════════           │
│      │                    │                      │                    │
│      │ 导出 SRTP 密钥     │                      │   导出 SRTP 密钥   │
│      │                    │                      │                    │
│  ════════════════════ 阶段 6: 媒体传输 ════════════════════            │
│      │                    │                      │                    │
│      │ ═══════════════ SRTP (音视频数据) ═══════════════════════════> │
│      │ <═══════════════ SRTP (音视频数据) ═══════════════════════════ │
│      │                    │                      │                    │
│      │ <═══════════════ SRTCP (反馈) ════════════════════════════════ │
│      │ ═══════════════ SRTCP (反馈) ════════════════════════════════> │
│      │                    │                      │                    │
│      │ connectionState: connected                │                    │
│      │                    │                      │                    │
│  ════════════════════ 通话进行中 ════════════════════                  │
│      │                    │                      │                    │
│  ════════════════════ 阶段 7: 连接关闭 ════════════════════            │
│      │                    │                      │                    │
│      │ ── Hangup ────────>│                      │                    │
│      │                    │ ── Hangup ──────────────────────────────> │
│      │                    │                      │                    │
│      │ pc.close()         │                      │   pc.close()       │
│      │                    │                      │                    │
│      │ connectionState: closed                   │                    │
│      │                    │                      │                    │
└─────────────────────────────────────────────────────────────────────────┘
```

### 8.2 各阶段耗时参考

| 阶段 | 典型耗时 | 影响因素 |
|------|---------|---------|
| 信令交换 | 100-500ms | 信令服务器延迟 |
| ICE 候选收集 | 500-2000ms | STUN/TURN 服务器响应 |
| ICE 连通性检测 | 100-1000ms | 网络状况、NAT 类型 |
| DTLS 握手 | 100-300ms | 网络延迟 |
| 总计 | 1-4 秒 | - |

---

## 9. 总结

### 9.1 关键流程回顾

```
1. Offer/Answer 交换
   - 交换媒体能力 (编解码器、方向)
   - 交换 ICE 凭据和 DTLS 指纹

2. ICE Candidate Trickle
   - 收集本地候选 (host, srflx, relay)
   - 交换候选地址

3. ICE 连通性检测
   - STUN Binding 请求/响应
   - 选择最优候选对

4. DTLS 握手
   - 建立安全通道
   - 验证对端身份 (fingerprint)

5. SRTP 建立
   - 从 DTLS 导出密钥
   - 准备媒体加密

6. 媒体传输
   - SRTP 加密传输
   - RTCP 反馈控制

7. 连接关闭
   - 发送挂断信令
   - 释放资源
```

### 9.2 状态监控要点

```javascript
// 监控所有关键状态
pc.onsignalingstatechange = () => {
    console.log('Signaling:', pc.signalingState);
};

pc.oniceconnectionstatechange = () => {
    console.log('ICE Connection:', pc.iceConnectionState);
};

pc.onicegatheringstatechange = () => {
    console.log('ICE Gathering:', pc.iceGatheringState);
};

pc.onconnectionstatechange = () => {
    console.log('Connection:', pc.connectionState);
};
```

### 9.3 第二部分总结

恭喜你完成了 WebRTC 信令与会话管理系列的学习。让我们回顾这六篇文章的核心内容:

| 篇章 | 主题 | 核心收获 |
|------|------|---------|
| 第 6 篇 | 信令基础 | 理解信令的作用和设计方法 |
| 第 7 篇 | SDP 详解 | 掌握 SDP 结构和 Offer/Answer 模型 |
| 第 8 篇 | ICE 框架 | 理解 NAT 穿透的完整流程 |
| 第 9 篇 | STUN 协议 | 掌握地址发现的原理和实现 |
| 第 10 篇 | TURN 服务器 | 学会搭建和配置中继服务器 |
| 第 11 篇 | 完整流程 | 建立从 0 到 1 的完整认知 |

### 9.4 下一步学习建议

1. **媒体处理**: 深入学习编解码器、音频处理
2. **服务端架构**: 学习 SFU/MCU 架构设计
3. **性能优化**: 弱网优化、质量监控
4. **生产实践**: 大规模部署、问题排查

---

## 参考资料

1. [RFC 8829 - JavaScript Session Establishment Protocol (JSEP)](https://datatracker.ietf.org/doc/html/rfc8829)
2. [RFC 8445 - Interactive Connectivity Establishment (ICE)](https://datatracker.ietf.org/doc/html/rfc8445)
3. [RFC 5764 - DTLS-SRTP](https://datatracker.ietf.org/doc/html/rfc5764)
4. [WebRTC for the Curious](https://webrtcforthecurious.com/)
5. [High Performance Browser Networking - WebRTC](https://hpbn.co/webrtc/)

---

> 作者: WebRTC 技术专栏  
> 系列: 信令与会话管理 (6/6)  
> 上一篇: [TURN: 中继服务器详解](./10-turn-server.md)

---

恭喜完成 WebRTC 信令与会话管理系列!
